/**!
 * The MIT License
 *
 * Copyright (c) 2013 the angular-leaflet-directive Team, http://tombatossals.github.io/angular-leaflet-directive
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * angular-google-maps
 * https://github.com/tombatossals/angular-leaflet-directive
 *
 * @authors https://github.com/tombatossals/angular-leaflet-directive/graphs/contributors
 */

/*! angular-openlayers-directive 11-09-2014 */
!function(){"use strict";angular.module("openlayers-directive",[]).directive("openlayers",["$log","$q","olHelpers","olMapDefaults","olData",function(a,b,c,d,e){var f=b.defer();return{restrict:"EA",replace:!0,scope:{center:"=center",defaults:"=defaults",layers:"=layers"},transclude:!0,template:'<div class="angular-openlayers-map"><div ng-transclude></div></div>',controller:["$scope",function(a){this.getMap=function(){return f.promise},this.getOpenlayersScope=function(){return a}}],link:function(a,b,g){var h=c.isDefined,i=c.createLayer,j=d.setDefaults(a.defaults,g.id);h(g.width)&&(isNaN(g.width)?b.css("width",g.width):b.css("width",g.width+"px")),h(g.height)&&(isNaN(g.height)?b.css("height",g.height):b.css("height",g.height+"px"));var k=ol.control.defaults(j.controls),l=ol.interaction.defaults(j.interactions),m=new ol.Map({target:b[0],controls:k,interactions:l});if(!h(g.layers)){var n=i(j.layers.main);m.addLayer(n)}h(g.center)||m.setView(new ol.View({center:[j.center.lon,j.center.lat],zoom:j.center.zoom,maxZoom:j.center.maxZoom,minZoom:j.center.minZoom})),e.setMap(m,g.id),f.resolve(m)}}}]),angular.module("openlayers-directive").directive("center",["$log","$location","olMapDefaults","olHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"openlayers",link:function(e,f,g,h){var i=d.safeApply,j=d.isValidCenter,k=d.isDefined,l=d.isSameCenterOnMap,m=d.equals,n=h.getOpenlayersScope();h.getMap().then(function(d){var e=c.getDefaults(g.id),f=n.center;if(-1!==g.center.search("-"))return a.error('[AngularJS - Openlayers] The "center" variable can\'t use a "-" on his key name: "'+g.center+'".'),void d.setView(new ol.View({center:ol.proj.transform([e.center.lon,e.center.lat],"EPSG:4326","EPSG:3857")}));j(f)||(a.warn("[AngularJS - Openlayers] invalid 'center'"),f=angular.copy(e.center));var h=new ol.View({center:ol.proj.transform([f.lon,f.lat],"EPSG:4326","EPSG:3857"),zoom:f.zoom,maxZoom:e.maxZoom,minZoom:e.minZoom});d.setView(h);var o;if(f.centerUrlHash===!0){var p=function(){var a,c=b.search();if(k(c.c)){var d=c.c.split(":");3===d.length&&(a={lat:parseFloat(d[0]),lon:parseFloat(d[1]),zoom:parseInt(d[2],10)})}return a};o=p(),n.$on("$locationChangeSuccess",function(a){var b=a.currentScope,c=p();k(c)&&!l(c,d)&&(b.center={lat:c.lat,lon:c.lon,zoom:c.zoom})})}var q;n.$watch("center",function(b){if(b.autodiscover)return q||(q=new ol.Geolocation({projection:ol.proj.get("EPSG:4326")}),q.on("change",function(){if(console.log("change"),b.autodiscover){var a=q.getPosition();i(n,function(b){b.center.lat=a[1],b.center.lon=a[0],b.center.zoom=12,b.center.autodiscover=!1,q.setTracking(!1)})}})),console.log("settracking"),void q.setTracking(!0);if(j(b)||(a.warn("[AngularJS - Openlayers] invalid 'center'"),b=e.center),h.getCenter()){var c=ol.proj.transform(h.getCenter(),"EPSG:3857","EPSG:4326");if(!m({lat:c[1],lon:c[1]},{lat:b.lat,lon:b.lon})){var d=ol.proj.transform([b.lon,b.lat],"EPSG:4326","EPSG:3857");h.setCenter(d)}}h.getZoom()!==b.zoom&&h.setZoom(b.zoom)},!0),h.on("change:resolution",function(){i(n,function(a){a.center&&a.center.zoom!==h.getZoom()&&(a.center.zoom=h.getZoom())})}),h.on("change:center",function(){i(n,function(a){var b=d.getView().getCenter(),c=ol.proj.transform(b,"EPSG:3857","EPSG:4326");a.center&&(a.center.lat=c[1],a.center.lon=c[0])})})})}}}]),angular.module("openlayers-directive").directive("layers",["$log","$q","olData","olMapDefaults","olHelpers",function(a,b,c,d,e){var f;return{restrict:"A",scope:!1,replace:!1,require:"openlayers",controller:function(){f=b.defer(),this.getLayers=function(){return f.promise}},link:function(b,g,h,i){var j=e.isDefined,k=e.equals,l={},m=i.getOpenlayersScope(),n=e.createLayer;i.getMap().then(function(b){var e=d.getDefaults(h.id);m.$watch("layers",function(c,d){if(j(c)&&j(c.main)&&j(c.main.type)||(a.warn("[AngularJS - OpenLayers] At least one main layer has to be defined."),c=angular.copy(e.layers)),j(c.main)&&j(c.main.type)&&j(d.main)&&j(d.main.type)&&c.main.type===d.main.type&&c.main.url!==d.main.url)return void l.main.getSource().setUrl(c.main.url);if(!j(l.main)||!k(c.main,d.main)){j(l.main)&&d.main.type!==c.main.type&&b.removeLayer(l.main);var g=n(c.main);b.addLayer(g),l.main=g}f.resolve(l)},!0),c.setLayers(l,h.id)})}}}]),angular.module("openlayers-directive").service("olData",["$log","$q","olHelpers",function(a,b,c){var d=c.obtainEffectiveMapId,e={},f={},g=function(a,b){var c=d(a,b);a[c].resolvedDefer=!0},h=function(a,c){var e,f=d(a,c);return angular.isDefined(a[f])&&a[f].resolvedDefer!==!0?e=a[f].defer:(e=b.defer(),a[f]={defer:e,resolvedDefer:!1}),e},i=function(a,b){var c,e=d(a,b);return c=angular.isDefined(a[e])&&a[e].resolvedDefer!==!1?a[e].defer:h(a,b)};this.setMap=function(a,b){var c=h(e,b);c.resolve(a),g(e,b)},this.getMap=function(a){var b=i(e,a);return b.promise},this.getLayers=function(a){var b=i(f,a);return b.promise},this.setLayers=function(a,b){var c=h(f,b);c.resolve(a),g(f,b)}}]),angular.module("openlayers-directive").factory("olHelpers",["$q","$log",function(a,b){var c=function(a){return angular.isDefined(a)};return{isDefined:c,isNumber:function(a){return angular.isNumber(a)},isDefinedAndNotNull:function(a){return angular.isDefined(a)&&null!==a},isString:function(a){return angular.isString(a)},isArray:function(a){return angular.isArray(a)},isObject:function(a){return angular.isObject(a)},equals:function(a,b){return angular.equals(a,b)},isValidCenter:function(a){return angular.isDefined(a)&&(angular.isNumber(a.lat)&&angular.isNumber(a.lon)||"boolean"==typeof a.autodiscover||angular.isArray(a.bounds)&&4===a.bounds.length&&angular.isNumber(a.bounds[0])&&angular.isNumber(a.bounds[1])&&angular.isNumber(a.bounds[1])&&angular.isNumber(a.bounds[2]))},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)},isSameCenterOnMap:function(a,b){var c=b.getView().getCenter(),d=b.getView().getZoom();return c[1].toFixed(4)===a.lat.toFixed(4)&&c[1].toFixed(4)===a.lon.toFixed(4)&&d===a.zoom?!0:!1},obtainEffectiveMapId:function(a,c){var d,e;if(angular.isDefined(c))d=c;else if(1===Object.keys(a).length)for(e in a)a.hasOwnProperty(e)&&(d=e);else 0===Object.keys(a).length?d="main":b.error("[AngularJS - Openlayers] - You have more than 1 map on the DOM, you must provide the map ID to the olData.getXXX call");return d},generateUniqueUID:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},createLayer:function(a){var b,c;switch(a.type){case"OSM":c=a.attribution?new ol.source.OSM({attributions:[new ol.Attribution({html:a.attribution}),ol.source.OSM.DATA_ATTRIBUTION]}):new ol.source.OSM,b=new ol.layer.Tile({source:c}),a.url&&c.setUrl(a.url);break;case"TileJSON":c=new ol.source.TileJSON({url:a.url,crossOrigin:"anonymous"}),b=new ol.layer.Tile({source:c})}return b}}}]),angular.module("openlayers-directive").factory("olMapDefaults",["$q","olHelpers",function(a,b){var c=function(){return{interactions:{dragRotate:!0,doubleClickZoom:!0,dragPan:!0,pinchRotate:!0,pinchZoom:!0,keyboardPan:!0,keyboardZoom:!0,mouseWheelZoom:!0,dragZoom:!0},layers:{main:{type:"OSM"}},minZoom:void 0,maxZoom:void 0,center:{lat:0,lon:0,zoom:1,autodiscover:!1,bounds:[],centerUrlHash:!1},controls:{attribution:!0,rotate:!1,zoom:!0}}},d=b.isDefined,e=b.obtainEffectiveMapId,f={};return{getDefaults:function(a){var b=e(f,a);return f[b]},setDefaults:function(a,b){var g=c();d(a)&&(d(a.layers)&&(g.layers=angular.copy(a.layers)),d(a.controls)&&(g.controls=angular.copy(a.controls)),d(a.interactions)&&(g.interactions=angular.copy(a.interactions)),d(a.minZoom)&&(g.minZoom=a.minZoom),d(a.maxZoom)&&(g.maxZoom=a.maxZoom));var h=e(f,b);return f[h]=g,g}}}])}();