/**!
 * The MIT License
 *
 * Copyright (c) 2013 the angular-openlayers-directive Team, http://tombatossals.github.io/angular-openlayers-directive
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * angular-google-maps
 * https://github.com/tombatossals/angular-openlayers-directive
 *
 * @authors https://github.com/tombatossals/angular-openlayers-directive/graphs/contributors
 */

/*! angular-openlayers-directive 23-07-2015 */
!function(){"use strict";angular.module("openlayers-directive",["ngSanitize"]).directive("openlayers",["$log","$q","$compile","olHelpers","olMapDefaults","olData",function(a,b,c,d,e,f){return{restrict:"EA",transclude:!0,replace:!0,scope:{center:"=olCenter",defaults:"=olDefaults",view:"=olView",events:"=olEvents"},template:'<div class="angular-openlayers-map" ng-transclude></div>',controller:["$scope",function(a){var c=b.defer();a.getMap=function(){return c.promise},a.setMap=function(a){c.resolve(a)},this.getOpenlayersScope=function(){return a}}],link:function(a,b,c){var g=d.isDefined,h=d.createLayer,i=d.setMapEvents,j=d.createView,k=e.setDefaults(a);g(c.width)&&(isNaN(c.width)?b.css("width",c.width):b.css("width",c.width+"px")),g(c.height)&&(isNaN(c.height)?b.css("height",c.height):b.css("height",c.height+"px")),g(c.lat)&&(k.center.lat=parseFloat(c.lat)),g(c.lon)&&(k.center.lon=parseFloat(c.lon)),g(c.zoom)&&(k.center.zoom=parseFloat(c.zoom));var l=ol.control.defaults(k.controls),m=ol.interaction.defaults(k.interactions),n=j(k.view),o=new ol.Map({target:b[0],controls:l,interactions:m,renderer:k.renderer,view:n});if(!c.customLayers){var p={type:"Tile",source:{type:"OSM"}},q=h(p,n.getProjection(),"default");o.addLayer(q),o.set("default",!0)}if(!g(c.olCenter)){var r=ol.proj.transform([k.center.lon,k.center.lat],k.center.projection,n.getProjection());n.setCenter(r),n.setZoom(k.center.zoom)}i(k.events,o,a),a.setMap(o),f.setMap(o,c.id)}}}]),angular.module("openlayers-directive").directive("olCenter",["$log","$location","olMapDefaults","olHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"openlayers",link:function(e,f,g,h){var i=d.safeApply,j=d.isValidCenter,k=d.isDefined,l=d.isArray,m=d.isNumber,n=d.isSameCenterOnMap,o=d.setCenter,p=d.setZoom,q=h.getOpenlayersScope();q.getMap().then(function(e){var f=c.getDefaults(q),h=e.getView(),r=q.center;if(-1!==g.olCenter.search("-"))return a.error('[AngularJS - Openlayers] The "center" variable can\'t use a "-" on his key name: "'+g.center+'".'),void o(h,f.view.projection,f.center,e);k(r)||(r={}),j(r)||(a.warn("[AngularJS - Openlayers] invalid 'center'"),r.lat=f.center.lat,r.lon=f.center.lon,r.zoom=f.center.zoom,r.projection=f.center.projection),r.projection||("pixel"!==f.view.projection?r.projection=f.center.projection:r.projection="pixel"),m(r.zoom)||(r.zoom=1),o(h,f.view.projection,r,e),h.setZoom(r.zoom);var s;if(r.centerUrlHash===!0){var t=function(){var a,c=b.search();if(k(c.c)){var d=c.c.split(":");3===d.length&&(a={lat:parseFloat(d[0]),lon:parseFloat(d[1]),zoom:parseInt(d[2],10)})}return a};s=t(),q.$on("$locationChangeSuccess",function(){var a=t();a&&!n(a,e)&&i(q,function(b){b.center.lat=a.lat,b.center.lon=a.lon,b.center.zoom=a.zoom})})}var u;q.$watchCollection("center",function(b){if(b){if(b.projection||(b.projection=f.center.projection),b.autodiscover)return u||(u=new ol.Geolocation({projection:ol.proj.get(b.projection)}),u.on("change",function(){if(b.autodiscover){var a=u.getPosition();i(q,function(b){b.center.lat=a[1],b.center.lon=a[0],b.center.zoom=12,b.center.autodiscover=!1,u.setTracking(!1)})}})),void u.setTracking(!0);j(b)||(a.warn("[AngularJS - Openlayers] invalid 'center'"),b=f.center);var c=h.getCenter();if(c){if("pixel"===f.view.projection)return void h.setCenter(b.coord);var d=ol.proj.transform(c,f.view.projection,b.projection);(d[1]!==b.lat||d[0]!==b.lon)&&o(h,f.view.projection,b,e)}h.getZoom()!==b.zoom&&p(h,b.zoom,e)}}),e.on("moveend",function(){i(q,function(a){if(k(a.center)){var c=e.getView().getCenter();if(a.center.zoom=h.getZoom(),"pixel"===f.view.projection)return void(a.center.coord=c);if(a.center){var g=ol.proj.transform(c,f.view.projection,a.center.projection);if(a.center.lat=g[1],a.center.lon=g[0],d.notifyCenterUrlHashChanged(q,a.center,b.search()),l(a.center.bounds)){var i=h.calculateExtent(e.getSize()),j=a.center.projection,m=f.view.projection;a.center.bounds=ol.proj.transformExtent(i,m,j)}}}})})})}}}]),angular.module("openlayers-directive").directive("olLayer",["$log","$q","olMapDefaults","olHelpers",function(a,b,c,d){return{restrict:"E",scope:{properties:"=olLayerProperties"},replace:!1,require:"^openlayers",link:function(a,b,e,f){var g=d.isDefined,h=d.equals,i=f.getOpenlayersScope(),j=d.createLayer,k=d.setVectorLayerEvents,l=d.detectLayerType,m=d.createStyle,n=d.isBoolean,o=d.addLayerBeforeMarkers,p=d.isNumber,q=d.insertLayer,r=d.removeLayer;i.getMap().then(function(b){var d,f=b.getView().getProjection(),s=c.setDefaults(i),t=b.getLayers();if(a.$on("$destroy",function(){r(t,d.index),b.removeLayer(d)}),g(a.properties))a.$watch("properties",function(c,e){if(g(c.source)&&g(c.source.type)){if(!g(c.visible))return void(c.visible=!0);if(!g(c.opacity))return void(c.opacity=1);var i;if(g(d)){if(g(e)&&!h(c.source,e.source)){if(!h(c.source,e.source)){var u=d.index;t.removeAt(u),d=j(c,f),g(d)&&(q(t,u,d),"Vector"===l(c)&&k(s.events,b,a,c.name))}c.style&&(i=angular.isFunction(c.style)?c.style:m(c.style),d.setStyle(i)),g(c.index)&&c.index!==d.index&&(r(t,d.index),q(t,c.index,d)),n(c.visible)&&c.visible!==e.visible&&d.setVisible(c.visible),c.opacity!==e.opacity&&(p(c.opacity)||p(parseFloat(c.opacity)))&&d.setOpacity(c.opacity)}g(c.style)&&!h(c.style,e.style)&&(i=angular.isFunction(c.style)?c.style:m(c.style),d.setStyle(i))}else d=j(c,f),g(c.index)?q(t,c.index,d):o(t,d),"Vector"===l(c)&&k(s.events,b,a,c.name),n(c.visible)&&d.setVisible(c.visible),c.opacity&&d.setOpacity(c.opacity),angular.isArray(c.extent)&&d.setExtent(c.extent),c.style&&(i=angular.isFunction(c.style)?c.style:m(c.style),d.setStyle(i))}},!0);else if(g(e.sourceType)&&g(e.sourceUrl)){var u={source:{url:e.sourceUrl,type:e.sourceType}};d=j(u,f,e.layerName),"Vector"===l(u)&&k(s.events,b,a,e.name),o(t,d)}})}}}]),angular.module("openlayers-directive").directive("olPath",["$log","$q","olMapDefaults","olHelpers",function(a,b,c,d){return{restrict:"E",scope:{properties:"=olGeomProperties"},require:"^openlayers",replace:!0,template:'<div class="popup-label path" ng-bind-html="message"></div>',link:function(a,b,e,f){var g=d.isDefined,h=d.createFeature,i=d.createOverlay,j=d.createVectorLayer,k=f.getOpenlayersScope();k.getMap().then(function(d){var f=c.getDefaults(k),l=f.view.projection,m=j();if(d.addLayer(m),g(e.coords)){var n=e.proj||"EPSG:4326",o=JSON.parse(e.coords),p={type:"Polygon",coords:o,projection:n,style:f.styles.path},q=h(p,l);if(m.getSource().addFeature(q),e.message){a.message=e.message;var r=q.getGeometry().getExtent(),s=i(b,r);d.addOverlay(s)}}else;})}}}]),angular.module("openlayers-directive").directive("olView",["$log","$q","olData","olMapDefaults","olHelpers",function(a,b,c,d,e){return{restrict:"A",scope:!1,replace:!1,require:"openlayers",link:function(a,b,c,f){var g=f.getOpenlayersScope(),h=e.isNumber,i=e.safeApply,j=e.createView;g.getMap().then(function(a){var b=d.getDefaults(g),c=g.view;c.projection||(c.projection=b.view.projection),c.maxZoom||(c.maxZoom=b.view.maxZoom),c.minZoom||(c.minZoom=b.view.minZoom),c.rotation||(c.rotation=b.view.rotation);var e=j(c);a.setView(e),g.$watchCollection("view",function(a){h(a.rotation)&&e.setRotation(a.rotation)}),e.on("change:rotation",function(){i(g,function(b){b.view.rotation=a.getView().getRotation()})})})}}}]),angular.module("openlayers-directive").directive("olControl",["$log","$q","olData","olMapDefaults","olHelpers",function(a,b,c,d,e){return{restrict:"E",scope:{properties:"=olControlProperties"},replace:!1,require:"^openlayers",link:function(a,b,c,d){var f,g,h=e.isDefined,i=d.getOpenlayersScope();i.getMap().then(function(b){var d=e.getControlClasses,i=d();return a.$on("$destroy",function(){b.removeControl(f)}),h(a.properties)&&h(a.properties.control)?(f=a.properties.control,void b.addControl(f)):void(c.name&&(h(a.properties)&&(g=a.properties),f=new i[c.name](g),b.addControl(f)))})}}}]),angular.module("openlayers-directive").directive("olMarker",["$log","$q","olMapDefaults","olHelpers",function(a,b,c,d){var e=function(){return{projection:"EPSG:4326",lat:0,lon:0,coord:[],show:!0,showOnMouseOver:!1,showOnMouseClick:!1,keepOneOverlayVisible:!1}},f=function(){function a(a){return b.map(function(a){return a.map}).indexOf(a)}var b=[];return{getInst:function(c,e){var f=a(e);if(-1===f){var g=d.createVectorLayer();g.set("markers",!0),e.addLayer(g),b.push({map:e,markerLayer:g,instScopes:[]}),f=b.length-1}return b[f].instScopes.push(c),b[f].markerLayer},deregisterScope:function(c,d){var e=a(d);if(-1===e)throw Error("This map has no markers");var f=b[e].instScopes,g=f.indexOf(c);if(-1===g)throw Error("Scope wan't registered");f.splice(g,1),f.length||(d.removeLayer(b[e].markerLayer),delete b[e])}}}();return{restrict:"E",scope:{lat:"=lat",lon:"=lon",label:"=label",properties:"=olMarkerProperties",style:"=olStyle"},transclude:!0,require:"^openlayers",replace:!0,template:'<div class="popup-label marker"><div ng-bind-html="message"></div><ng-transclude></ng-transclude></div>',link:function(b,g,h,i){var j=d.isDefined,k=i.getOpenlayersScope(),l=d.createFeature,m=d.createOverlay,n=g.find("ng-transclude").children().length>0;k.getMap().then(function(d){var i,o,p,q=f.getInst(b,d),r=e(),s=c.getDefaults(k),t=s.view.projection;return b.$on("$destroy",function(){q.getSource().removeFeature(p),j(i)&&d.removeOverlay(i),f.deregisterScope(b,d)}),j(b.properties)?void b.$watch("properties",function(c){function e(a){if(!c.label.show){var e=!1,f=d.getEventPixel(a),h=d.forEachFeatureAtPixel(f,function(a){return a}),k=!1;h===p&&(k=!0,e=!0,j(i)||(o="pixel"===r.projection?r.coord:ol.proj.transform([r.lon,r.lat],r.projection,t),i=m(g,o),d.addOverlay(i)),!c.onClick||"click"!==a.type&&"touchend"!==a.type||b.$apply(function(){c.onClick.call(p,a,c)}),d.getTarget().style.cursor="pointer"),!e&&i&&(k=!0,d.removeOverlay(i),i=void 0,d.getTarget().style.cursor=""),k&&a.preventDefault()}}function f(a){if(!c.label.show){var b=!1,e=d.getEventPixel(a),f=d.forEachFeatureAtPixel(e,function(a){return a}),h=!1;f===p&&(h=!0,b=!0,j(i)||(o="pixel"===r.projection?r.coord:ol.proj.transform([r.lon,r.lat],r.projection,t),i=m(g,o),angular.forEach(d.getOverlays(),function(a){d.removeOverlay(a)}),d.addOverlay(i)),d.getTarget().style.cursor="pointer"),!b&&i&&(h=!0,i=void 0,d.getTarget().style.cursor=""),h&&a.preventDefault()}}function h(a){angular.forEach(d.getOverlays(),function(a){d.removeOverlay(a)}),a.preventDefault()}var k=function(){function a(){c=!0,b&&clearTimeout(b),b=setTimeout(function(){c=!1,b=null},500)}var b,c=!1;return d.getViewport().querySelector("canvas.ol-unselectable").addEventListener("touchmove",a),function(){c||(e.apply(null,arguments),a())}}();if(j(p)){var u=ol.proj.transform([c.lon,c.lat],r.projection,d.getView().getProjection());if(!angular.equals(p.getGeometry().getCoordinates(),u)){var v=new ol.geom.Point(u);p.setGeometry(v)}}else r.projection=c.projection?c.projection:r.projection,r.coord=c.coord?c.coord:r.coord,r.lat=c.lat?c.lat:r.lat,r.lon=c.lon?c.lon:r.lon,j(c.style)?r.style=c.style:r.style=s.styles.marker,p=l(r,t),j(p)||a.error("[AngularJS - Openlayers] Received invalid data on the marker."),q.getSource().addFeature(p);j(i)&&d.removeOverlay(i),j(c.label)&&(b.message=c.label.message,(n||j(b.message)&&0!==b.message.length)&&(c.label&&c.label.show===!0&&(o="pixel"===r.projection?r.coord:ol.proj.transform([c.lon,c.lat],r.projection,t),i=m(g,o),d.addOverlay(i)),i&&c.label&&c.label.show===!1&&(d.removeOverlay(i),i=void 0),c.label&&c.label.show===!1&&c.label.showOnMouseOver&&d.getViewport().addEventListener("mousemove",e),(c.label&&c.label.show===!1&&c.label.showOnMouseClick||c.onClick)&&(d.getViewport().addEventListener("click",k),d.getViewport().querySelector("canvas.ol-unselectable").addEventListener("touchend",k)),c.label&&c.label.show===!1&&c.label.keepOneOverlayVisible&&(d.getViewport().addEventListener("mousemove",f),d.getViewport().addEventListener("click",h))))},!0):(r.lat=b.lat?b.lat:r.lat,r.lon=b.lon?b.lon:r.lon,r.message=h.message,r.style=b.style?b.style:s.styles.marker,p=l(r,t),j(p)||a.error("[AngularJS - Openlayers] Received invalid data on the marker."),q.getSource().addFeature(p),void((r.message||n)&&(b.message=h.message,o=ol.proj.transform([r.lon,r.lat],r.projection,t),i=m(g,o),d.addOverlay(i))))})}}}]),angular.module("openlayers-directive").service("olData",["$log","$q","olHelpers",function(a,b,c){var d=c.obtainEffectiveMapId,e={},f=function(a,b){var c=d(a,b);a[c].resolvedDefer=!0},g=function(a,c){var e,f=d(a,c);return angular.isDefined(a[f])&&a[f].resolvedDefer!==!0?e=a[f].defer:(e=b.defer(),a[f]={defer:e,resolvedDefer:!1}),e},h=function(a,b){var c,e=d(a,b);return c=angular.isDefined(a[e])&&a[e].resolvedDefer!==!1?a[e].defer:g(a,b)};this.setMap=function(a,b){var c=g(e,b);c.resolve(a),f(e,b)},this.getMap=function(a){var b=h(e,a);return b.promise}}]),angular.module("openlayers-directive").factory("olHelpers",["$q","$log","$http",function(a,b,c){var d=function(a){return angular.isDefined(a)},e=function(a,b,c){a.on(b,function(d){var e=d.coordinate,f=a.getView().getProjection().getCode();"pixel"===f&&(e=e.map(function(a){return parseInt(a,10)})),c.$emit("openlayers.map."+b,{coord:e,projection:f,event:d})})},f=["Road","Aerial","AerialWithLabels","collinsBart","ordnanceSurvey"],g=function(){return{attribution:ol.control.Attribution,fullscreen:ol.control.FullScreen,mouseposition:ol.control.MousePosition,rotate:ol.control.Rotate,scaleline:ol.control.ScaleLine,zoom:ol.control.Zoom,zoomslider:ol.control.ZoomSlider,zoomtoextent:ol.control.ZoomToExtent}},h=["osm","sat","hyb"],i=["World_Imagery","World_Street_Map","World_Topo_Map","World_Physical_Map","World_Terrain_Base","Ocean_Basemap","NatGeo_World_Map"],j={style:ol.style.Style,fill:ol.style.Fill,stroke:ol.style.Stroke,circle:ol.style.Circle,icon:ol.style.Icon,image:ol.style.Image,regularshape:ol.style.RegularShape,text:ol.style.Text},k=function(a,b){return b&&a instanceof b?a:b?new b(a):a},l=function q(a,b){var c;if(b?c=a[b]:(b="style",c=a),"style"===b&&a instanceof Function)return a;if(!(c instanceof Object))return c;var d;if("[object Object]"===Object.prototype.toString.call(c)){d={};var e=j[b];if(e&&c instanceof e)return c;Object.getOwnPropertyNames(c).forEach(function(a,f,g){var h=j[a];return e&&h&&h.prototype instanceof j[b]?(console.assert(1===g.length,"Extra parameters for "+b),d=q(c,a),k(d,h)):(d[a]=q(c,a),void(d[a]=k(d[a],j[a])))})}else d=c;return k(d,j[b])},m=function(a){if(a.type)return a.type;switch(a.source.type){case"ImageWMS":return"Image";case"ImageStatic":return"Image";case"GeoJSON":return"Vector";case"JSONP":return"Vector";case"TopoJSON":return"Vector";case"KML":return"Vector";case"TileVector":return"Vector";default:return"Tile"}},n=function(a){var c;switch(a.projection){case"pixel":if(!d(a.extent))return void b.error("[AngularJS - Openlayers] - You must provide the extent of the image if using pixel projection");c=new ol.proj.Projection({code:"pixel",units:"pixels",extent:a.extent});break;default:c=new ol.proj.get(a.projection)}return c},o=function(a){return-1!==["watercolor","terrain","toner"].indexOf(a)},p=function(a,e){var g;switch(a.type){case"MapBox":if(!a.mapId||!a.accessToken)return void b.error("[AngularJS - Openlayers] - MapBox layer requires the map id and the access token");var j="http://api.tiles.mapbox.com/v4/"+a.mapId+"/{z}/{x}/{y}.png?access_token="+a.accessToken,k=window.devicePixelRatio;k>1&&(j=j.replace(".png","@2x.png")),g=new ol.source.XYZ({url:j,tilePixelRatio:k>1?2:1});break;case"ImageWMS":a.url&&a.params||b.error("[AngularJS - Openlayers] - ImageWMS Layer needs valid server url and params properties"),g=new ol.source.ImageWMS({url:a.url,crossOrigin:"undefined"==typeof a.crossOrigin?"anonymous":a.crossOrigin,params:a.params});break;case"TileWMS":(a.url||a.urls)&&a.params||b.error("[AngularJS - Openlayers] - TileWMS Layer needs valid url (or urls) and params properties");var l={crossOrigin:"undefined"==typeof a.crossOrigin?"anonymous":a.crossOrigin,params:a.params};a.url&&(l.url=a.url),a.urls&&(l.urls=a.urls),g=new ol.source.TileWMS(l);break;case"WMTS":a.url&&a.tileGrid||b.error("[AngularJS - Openlayers] - WMTS Layer needs valid url and tileGrid properties"),g=new ol.source.WMTS({url:a.url,projection:e,matrixSet:"undefined"===a.matrixSet?e:a.matrixSet,format:"undefined"===a.format?"image/jpeg":a.format,requestEncoding:"undefined"===a.requestEncoding?"KVP":a.requestEncoding,tileGrid:new ol.tilegrid.WMTS({origin:a.tileGrid.origin,resolutions:a.tileGrid.resolutions,matrixIds:a.tileGrid.matrixIds})});break;case"OSM":if(a.attribution){var m=[];d(a.attribution)&&m.unshift(new ol.Attribution({html:a.attribution})),g=new ol.source.OSM({attributions:m})}else g=new ol.source.OSM;a.url&&g.setUrl(a.url);break;case"BingMaps":if(!a.key)return void b.error("[AngularJS - Openlayers] - You need an API key to show the Bing Maps.");var n={key:a.key,imagerySet:a.imagerySet?a.imagerySet:f[0]};a.maxZoom&&(n.maxZoom=a.maxZoom),g=new ol.source.BingMaps(n);break;case"MapQuest":if(!a.layer||-1===h.indexOf(a.layer))return void b.error("[AngularJS - Openlayers] - MapQuest layers needs a valid 'layer' property.");g=new ol.source.MapQuest({layer:a.layer});break;case"EsriBaseMaps":if(!a.layer||-1===i.indexOf(a.layer))return void b.error("[AngularJS - Openlayers] - ESRI layers needs a valid 'layer' property.");var p="http://services.arcgisonline.com/ArcGIS/rest/services/",q=p+a.layer+"/MapServer/tile/{z}/{y}/{x}";g=new ol.source.XYZ({url:q});break;case"GeoJSON":if(!a.geojson&&!a.url)return void b.error("[AngularJS - Openlayers] - You need a geojson property to add a GeoJSON layer.");d(a.url)?g=new ol.source.GeoJSON({projection:e,url:a.url}):(d(a.geojson.projection)||(a.geojson.projection=e),g=new ol.source.GeoJSON(a.geojson));break;case"JSONP":if(!a.url)return void b.error("[AngularJS - Openlayers] - You need an url properly configured to add a JSONP layer.");d(a.url)&&(g=new ol.source.ServerVector({format:new ol.format.GeoJSON,loader:function(){var d=a.url+"&outputFormat=text/javascript&format_options=callback:JSON_CALLBACK";c.jsonp(d,{cache:a.cache}).success(function(a){g.addFeatures(g.readFeatures(a))}).error(function(a){b(a)})},projection:e}));break;case"TopoJSON":if(!a.topojson&&!a.url)return void b.error("[AngularJS - Openlayers] - You need a topojson property to add a TopoJSON layer.");g=a.url?new ol.source.TopoJSON({projection:e,url:a.url}):new ol.source.TopoJSON(a.topojson);break;case"TileJSON":g=new ol.source.TileJSON({url:a.url,crossOrigin:"anonymous"});break;case"TileVector":a.url&&a.format||b.error("[AngularJS - Openlayers] - TileVector Layer needs valid url and format properties"),g=new ol.source.TileVector({url:a.url,projection:e,format:a.format,tileGrid:new ol.tilegrid.XYZ({maxZoom:a.maxZoom||19})});break;case"TileTMS":a.url&&a.tileGrid||b.error("[AngularJS - Openlayers] - TileTMS Layer needs valid url and tileGrid properties"),g=new ol.source.TileImage({url:a.url,maxExtent:a.maxExtent,tileGrid:new ol.tilegrid.TileGrid({origin:a.tileGrid.origin,resolutions:a.tileGrid.resolutions}),tileUrlFunction:function(b){var c=b[0],d=b[1],e=b[2];if(0>d||0>e)return"";var f=a.url+c+"/"+d+"/"+e+".png";return f}});break;case"TileImage":g=new ol.source.TileImage({url:a.url,tileGrid:new ol.tilegrid.TileGrid({origin:a.tileGrid.origin,resolutions:a.tileGrid.resolutions}),tileUrlFunction:function(b){var c=b[0],d=b[1],e=-b[2]-1,f=a.url.replace("{z}",c.toString()).replace("{x}",d.toString()).replace("{y}",e.toString());return f}});break;case"KML":var r=a.extractStyles||!1;g=new ol.source.KML({url:a.url,projection:a.projection,radius:a.radius,extractStyles:r});break;case"Stamen":if(!a.layer||!o(a.layer))return void b.error("[AngularJS - Openlayers] - You need a valid Stamen layer.");g=new ol.source.Stamen({layer:a.layer});break;case"ImageStatic":if(!a.url||!angular.isArray(a.imageSize)||2!==a.imageSize.length)return void b.error("[AngularJS - Openlayers] - You need a image URL to create a ImageStatic layer.");g=new ol.source.ImageStatic({url:a.url,imageSize:a.imageSize,projection:e,imageExtent:e.getExtent(),imageLoadFunction:a.imageLoadFunction})}return g||b.warn('[AngularJS - Openlayers] - No source could be found for type "'+a.type+'"'),g};return{isDefined:d,isNumber:function(a){return angular.isNumber(a)},createView:function(a){var b=n(a);return new ol.View({projection:b,maxZoom:a.maxZoom,minZoom:a.minZoom,extent:a.extent})},isDefinedAndNotNull:function(a){return angular.isDefined(a)&&null!==a},isString:function(a){return angular.isString(a)},isArray:function(a){return angular.isArray(a)},isObject:function(a){return angular.isObject(a)},equals:function(a,b){return angular.equals(a,b)},isValidCenter:function(a){return angular.isDefined(a)&&("boolean"==typeof a.autodiscover||angular.isNumber(a.lat)&&angular.isNumber(a.lon)||angular.isArray(a.coord)&&2===a.coord.length&&angular.isNumber(a.coord[0])&&angular.isNumber(a.coord[1])||angular.isArray(a.bounds)&&4===a.bounds.length&&angular.isNumber(a.bounds[0])&&angular.isNumber(a.bounds[1])&&angular.isNumber(a.bounds[1])&&angular.isNumber(a.bounds[2]))},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)},isSameCenterOnMap:function(a,b){var c=a.projection||"EPSG:4326",d=[a.lon,a.lat],e=b.getView().getProjection(),f=ol.proj.transform(b.getView().getCenter(),e,c),g=b.getView().getZoom();return f[1].toFixed(4)===d[1].toFixed(4)&&f[0].toFixed(4)===d[0].toFixed(4)&&g===a.zoom?!0:!1},setCenter:function(a,b,c,d){if(d&&a.getCenter()){var e=ol.animation.pan({duration:150,source:a.getCenter()});d.beforeRender(e)}if(c.projection===b)a.setCenter([c.lon,c.lat]);else{var f=[c.lon,c.lat];a.setCenter(ol.proj.transform(f,c.projection,b))}},setZoom:function(a,b,c){var d=ol.animation.zoom({duration:150,resolution:c.getView().getResolution()});c.beforeRender(d),a.setZoom(b)},isBoolean:function(a){return"boolean"==typeof a},obtainEffectiveMapId:function(a,c){var d,e;if(angular.isDefined(c))d=c;else if(1===Object.keys(a).length)for(e in a)a.hasOwnProperty(e)&&(d=e);else 0===Object.keys(a).length?d="main":b.error("[AngularJS - Openlayers] - You have more than 1 map on the DOM, you must provide the map ID to the olData.getXXX call");return d},createStyle:l,setMapEvents:function(a,b,c){if(d(a)&&angular.isArray(a.map))for(var f in a.map){var g=a.map[f];e(b,g,c)}},setVectorLayerEvents:function(a,b,c,e){d(a)&&angular.isArray(a.layers)&&angular.forEach(a.layers,function(a){angular.element(b.getViewport()).on(a,function(f){var g=b.getEventPixel(f),h=b.forEachFeatureAtPixel(g,function(a,b){return b.get("name")===e?a:null});d(h)&&c.$emit("openlayers.layers."+e+"."+a,h,f)})})},detectLayerType:m,createLayer:function(a,b,c){var e,f=m(a),g=p(a.source,b);if(g){switch("Vector"===f&&a.clustering&&(g=new ol.source.Cluster({source:g,distance:a.clusteringDistance})),f){case"Image":e=new ol.layer.Image({source:g});break;case"Tile":e=new ol.layer.Tile({source:g});break;case"Heatmap":e=new ol.layer.Heatmap({source:g});break;case"Vector":e=new ol.layer.Vector({source:g})}return d(c)?e.set("name",c):d(a.name)&&e.set("name",a.name),e}},createVectorLayer:function(){return new ol.layer.Vector({source:new ol.source.Vector})},notifyCenterUrlHashChanged:function(a,b,c){if(b.centerUrlHash){var e=b.lat.toFixed(4)+":"+b.lon.toFixed(4)+":"+b.zoom;d(c.c)&&c.c===e||a.$emit("centerUrlHash",e)}},getControlClasses:g,detectControls:function(a){var b={},c=g();return a.forEach(function(a){for(var d in c)a instanceof c[d]&&(b[d]=a)}),b},createFeature:function(a,b){var c;switch(a.type){case"Polygon":c=new ol.geom.Polygon(a.coords);break;default:c=d(a.coord)&&"pixel"===a.projection?new ol.geom.Point(a.coord):new ol.geom.Point([a.lon,a.lat])}d(a.projection)&&"pixel"!==a.projection&&(c=c.transform(a.projection,b));var e=new ol.Feature({geometry:c});if(d(a.style)){var f=l(a.style);e.setStyle(f)}return e},addLayerBeforeMarkers:function(a,b){for(var c,e=0;e<a.getLength();e++){var f=a.item(e);if(f.get("markers")){c=e;break}}if(d(c)){var g=a.item(c);b.index=c,a.setAt(c,b),g.index=a.getLength(),a.push(g)}else b.index=a.getLength(),a.push(b)},removeLayer:function(a,b){a.removeAt(b);for(var c=b;c<a.getLength();c++){var d=a.item(c);if(null===d){a.insertAt(c,null);break}d.index=c}},insertLayer:function(a,b,c){if(a.getLength()<b){for(;a.getLength()<b;)a.push(null);c.index=b,a.push(c)}else{c.index=b,a.insertAt(c.index,c);for(var d=b+1;d<a.getLength();d++){var e=a.item(d);if(null===e){a.removeAt(d);break}e.index=d}}},createOverlay:function(a,b){a.css("display","block");var c=new ol.Overlay({position:b,element:a,positioning:"center-left"});return c}}}]),angular.module("openlayers-directive").factory("olMapDefaults",["$q","olHelpers",function(a,b){var c="data:image/png;base64,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",d=function(){return{view:{projection:"EPSG:3857",minZoom:void 0,maxZoom:void 0,rotation:0,extent:void 0},center:{lat:0,lon:0,zoom:1,autodiscover:!1,bounds:[],centerUrlHash:!1,projection:"EPSG:4326"},styles:{path:{stroke:{color:"blue",width:8}},marker:{image:new ol.style.Icon({anchor:[.5,1],anchorXUnits:"fraction",anchorYUnits:"fraction",opacity:.9,src:c})}},events:{map:[],markers:[],layers:[]},controls:{attribution:!0,rotate:!1,zoom:!0},interactions:{mouseWheelZoom:!1},renderer:"canvas"}},e=b.isDefined,f={};return{getDefaults:function(a){if(!e(a))for(var b in f)return f[b];return f[a.$id]},setDefaults:function(a){var b=a.defaults,c=a.$id,g=d();return e(b)&&(e(b.layers)&&(g.layers=angular.copy(b.layers)),e(b.controls)&&(g.controls=angular.copy(b.controls)),e(b.events)&&(g.events=angular.copy(b.events)),e(b.interactions)&&(g.interactions=angular.copy(b.interactions)),e(b.renderer)&&(g.renderer=b.renderer),e(b.view)&&(g.view.maxZoom=b.view.maxZoom||g.view.maxZoom,g.view.minZoom=b.view.minZoom||g.view.minZoom,g.view.projection=b.view.projection||g.view.projection,g.view.extent=b.view.extent||g.view.extent),e(b.styles)&&(g.styles=angular.extend(g.styles,b.styles))),f[c]=g,g}}}])}();